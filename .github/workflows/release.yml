name: Create Release

on:
  push:
    branches: [ main ]

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Get current versions
      id: versions
      run: |
        echo "autoverpod_version=$(grep '^version:' autoverpod/pubspec.yaml | awk '{print $2}')" >> $GITHUB_OUTPUT
        echo "autoverpod_generator_version=$(grep '^version:' autoverpod_generator/pubspec.yaml | awk '{print $2}')" >> $GITHUB_OUTPUT
    
    - name: Check if version tags exist
      id: check_tags
      run: |
        AUTOVERPOD_TAG="autoverpod-v${{ steps.versions.outputs.autoverpod_version }}"
        GENERATOR_TAG="autoverpod_generator-v${{ steps.versions.outputs.autoverpod_generator_version }}"
        
        if git rev-parse --verify "refs/tags/$AUTOVERPOD_TAG" >/dev/null 2>&1; then
          echo "autoverpod_exists=true" >> $GITHUB_OUTPUT
        else
          echo "autoverpod_exists=false" >> $GITHUB_OUTPUT
        fi
        
        if git rev-parse --verify "refs/tags/$GENERATOR_TAG" >/dev/null 2>&1; then
          echo "generator_exists=true" >> $GITHUB_OUTPUT
        else
          echo "generator_exists=false" >> $GITHUB_OUTPUT
        fi
        
        echo "autoverpod_tag=$AUTOVERPOD_TAG" >> $GITHUB_OUTPUT
        echo "generator_tag=$GENERATOR_TAG" >> $GITHUB_OUTPUT
    
    - name: Create autoverpod release
      if: steps.check_tags.outputs.autoverpod_exists == 'false'
      uses: softprops/action-gh-release@v2
      with:
        token: ${{ secrets.RELEASE_TOKEN }}
        tag_name: ${{ steps.check_tags.outputs.autoverpod_tag }}
        name: autoverpod ${{ steps.versions.outputs.autoverpod_version }}
        body: |
          Release of autoverpod package version ${{ steps.versions.outputs.autoverpod_version }}
          
          ## Installation
          ```yaml
          dependencies:
            autoverpod: ^${{ steps.versions.outputs.autoverpod_version }}
          ```
        files: |
          autoverpod/pubspec.yaml
        draft: false
        prerelease: false
    
    - name: Create autoverpod_generator release
      if: steps.check_tags.outputs.generator_exists == 'false'
      uses: softprops/action-gh-release@v2
      with:
        token: ${{ secrets.RELEASE_TOKEN }}
        tag_name: ${{ steps.check_tags.outputs.generator_tag }}
        name: autoverpod_generator ${{ steps.versions.outputs.autoverpod_generator_version }}
        body: |
          Release of autoverpod_generator package version ${{ steps.versions.outputs.autoverpod_generator_version }}
          
          ## Installation
          ```yaml
          dev_dependencies:
            autoverpod_generator: ^${{ steps.versions.outputs.autoverpod_generator_version }}
          ```
        files: |
          autoverpod_generator/pubspec.yaml
        draft: false
        prerelease: false
